<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ğŸ”¥ Firebase JSON Admin Panel</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f7f9fb;margin:0;padding:20px}
h2{text-align:center;color:#333}
.card{background:#fff;padding:16px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,0.1);margin-bottom:20px}
input,button{padding:8px;margin:6px 0;border:1px solid #ccc;border-radius:5px;width:100%}
button{cursor:pointer}
button.save{background:#007bff;color:#fff}
button.update{background:#28a745;color:white;margin-top:5px}
button.danger{background:#dc3545;color:white;margin-top:5px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px}
.box{background:#fff;border:1px solid #ddd;border-radius:8px;padding:12px;box-shadow:0 2px 5px rgba(0,0,0,0.05)}
.box b{color:#007bff}
label{display:block;margin-bottom:5px}
#status{text-align:center;color:green;font-weight:bold;margin-top:10px}
</style>
</head>
<body>

<h2>ğŸ”¥ Firebase JSON Admin Panel (Google Login)</h2>

<div class="card" id="loginCard">
  <button id="googleLogin" class="save">ğŸ” Sign in with Google</button>
</div>

<div class="card" id="panelCard" style="display:none">
  <h3>Add / Update Key</h3>
  <label>Device ID</label>
  <input id="deviceId" placeholder="Enter Device ID">
  <label>Key</label>
  <input id="key" placeholder="Enter Key">
  <label>Expiry Date (dd-mm-yyyy)</label>
  <input id="expiry" placeholder="25-12-2025">
  <label>User (Remark)</label>
  <input id="user" placeholder="Enter User Name">
  <label><input id="offline" type="checkbox"> Allow Offline</label>
  <button id="saveBtn" class="save">ğŸ’¾ Save / Update</button>
  <div id="status"></div>
</div>

<div class="card" id="listCard" style="display:none">
  <h3>Existing Keys (Realtime)</h3>
  <div id="list" class="grid"></div>
  <button id="logoutBtn" class="danger">Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

// ğŸ”§ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyA1FIDLD-AKVlEz-AJiweYVdxhIP0Rnijk",
  authDomain: "opjat-2005.firebaseapp.com",
  databaseURL: "https://opjat-2005-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "opjat-2005",
  storageBucket: "opjat-2005.firebasestorage.app",
  messagingSenderId: "2500552965",
  appId: "1:2500552965:web:4f6664a366967a2525af6c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// ğŸ”’ Only admin Gmail
const ADMIN_EMAIL = "www.webomprakashjat@gmail.com";

const loginCard = document.getElementById('loginCard');
const panelCard = document.getElementById('panelCard');
const listCard = document.getElementById('listCard');
const googleLogin = document.getElementById('googleLogin');
const logoutBtn = document.getElementById('logoutBtn');
const statusDiv = document.getElementById('status');
const saveBtn = document.getElementById('saveBtn');

// ğŸ” Sign in with popup
googleLogin.onclick = async () => {
  try {
    await signInWithPopup(auth, provider);
  } catch (err) {
    alert("Login failed: " + err.message);
  }
};

// ğŸšª Logout
logoutBtn.onclick = async () => {
  await signOut(auth);
  loginCard.style.display = 'block';
  panelCard.style.display = 'none';
  listCard.style.display = 'none';
};

// ğŸ§  Auth state watcher
onAuthStateChanged(auth, async (user) => {
  if (user) {
    if (user.email !== ADMIN_EMAIL) {
      alert("ğŸš« Access Denied!\nOnly admin can log in.");
      await signOut(auth);
      loginCard.style.display = 'block';
      panelCard.style.display = 'none';
      listCard.style.display = 'none';
      return;
    }

    // âœ… If admin logged in
    loginCard.style.display = 'none';
    panelCard.style.display = 'block';
    listCard.style.display = 'block';
    loadRealtime();
  } else {
    loginCard.style.display = 'block';
    panelCard.style.display = 'none';
    listCard.style.display = 'none';
  }
});

// âœ… Save / Update
saveBtn.onclick = async () => {
  const id = document.getElementById('deviceId').value.trim();
  const key = document.getElementById('key').value.trim();
  const exp = document.getElementById('expiry').value.trim();
  const user = document.getElementById('user').value.trim();
  const allow = document.getElementById('offline').checked;

  if (!id || !key || !exp) {
    alert("Device ID, Key & Expiry Required!");
    return;
  }

  const data = { device_id: id, key: key, expirydate: exp, Allowoffline: allow, user: user };
  await set(ref(db, id), data);
  statusDiv.innerText = "âœ… Saved / Updated Successfully!";
  setTimeout(() => statusDiv.innerText = '', 2000);
  document.getElementById('deviceId').value = '';
  document.getElementById('key').value = '';
  document.getElementById('expiry').value = '';
  document.getElementById('user').value = '';
  document.getElementById('offline').checked = false;
};

// ğŸ§  Load realtime data
function loadRealtime() {
  const list = document.getElementById('list');
  onValue(ref(db), (snapshot) => {
    const data = snapshot.val() || {};
    list.innerHTML = '';
    Object.keys(data).forEach(id => {
      const item = data[id];
      const div = document.createElement('div');
      div.classList.add('box');
      div.innerHTML = `
        <b>${item.device_id || id}</b><br>
        ğŸ‘¤ ${item.user || 'â€”'}<br>
        ğŸ”‘ Key: <b>${item.key}</b><br>
        â° Expiry: ${item.expirydate}<br>
        ğŸ“´ Offline: ${item.Allowoffline}<br>
        <button class="update" onclick="updateItem('${id}')">âœï¸ Update</button>
        <button class="danger" onclick="firebaseDelete('${id}')">ğŸ—‘ Delete</button>
      `;
      list.appendChild(div);
    });
  });
}

// ğŸ—‘ Delete
window.firebaseDelete = async (id) => {
  if (confirm("Delete this key?")) {
    await remove(ref(db, id));
  }
};

// âœï¸ Update
window.updateItem = (id) => {
  import("https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js").then(({ getDatabase, ref, onValue }) => {
    const database = getDatabase(app);
    onValue(ref(database, id), (snapshot) => {
      const item = snapshot.val();
      if (item) {
        document.getElementById('deviceId').value = item.device_id;
        document.getElementById('key').value = item.key;
        document.getElementById('expiry').value = item.expirydate;
        document.getElementById('user').value = item.user;
        document.getElementById('offline').checked = item.Allowoffline;
        window.scrollTo(0, 0);
      }
    }, { onlyOnce: true });
  });
};
</script>
</body>
</html>
