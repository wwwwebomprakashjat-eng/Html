<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ðŸ”¥ NMMS Admin Panel</title>
<style>
body{margin:0;font-family:Poppins,sans-serif;background:#0a0a0a;color:#fff}
input,button{padding:10px;margin:5px;border-radius:6px;border:none}
input{background:#222;color:#fff;width:100%}
.card{background:#1a1a1a;padding:15px;border-radius:10px;margin:15px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:10px}
.item{background:#222;padding:10px;border-radius:8px}
.save{background:#ffc107;color:#000;font-weight:bold}
</style>
</head>

<body>

<div class="card" id="loginBox">
<h3>Admin Login</h3>
<button onclick="login()">Sign in with Google</button>
</div>

<div id="panel" style="display:none">
<div class="card">
<input id="deviceId" placeholder="Device ID">
<input id="key" placeholder="Key">
<input id="expiry" placeholder="Expiry">
<input id="username" placeholder="User Name">
<input id="position" placeholder="Insert Position (eg: 3)">
<label><input type="checkbox" id="allowOffline"> Allow Offline</label><br>
<button class="save" onclick="saveKey()">SAVE</button>
</div>

<div class="card">
<h3>All Keys</h3>
<div id="list" class="grid"></div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

const firebaseConfig = {
 apiKey: "AIzaSyA1FIDLD-AKVlEz-AJiweYVdxhIP0Rnijk",
 authDomain: "opjat-2005.firebaseapp.com",
 databaseURL: "https://opjat-2005-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId: "opjat-2005",
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

window.login = async()=>{
 let r = await signInWithPopup(auth, provider);
 if(r.user.email!="www.webomprakashjat@gmail.com"){alert("Not admin");return;}
 document.getElementById("loginBox").style.display="none";
 document.getElementById("panel").style.display="block";
 load();
}

function load(){
 onValue(ref(db,"keys"),s=>{
  let d=s.val()||{};
  list.innerHTML="";
  Object.keys(d).forEach(k=>{
   let v=d[k];
   list.innerHTML+=`
    <div class="item">
    ${k}. ${v.device_id}<br>
    ${v.user}<br>
    ${v.key}<br>
    ${v.expirydate}<br>
    Offline: ${v.Allowoffline}<br>
    <button onclick="del('${k}')">Delete</button>
    </div>`;
  });
 });
}

window.saveKey = ()=>{
 let obj={
  device_id:deviceId.value,
  key:key.value,
  expirydate:expiry.value,
  user:username.value,
  Allowoffline:allowOffline.checked
 };
 let pos=parseInt(position.value)||0;

 onValue(ref(db,"keys"),async s=>{
  let arr=Object.values(s.val()||{});
  if(pos>0 && pos<=arr.length) arr.splice(pos-1,0,obj);
  else arr.push(obj);

  let final={}; arr.forEach((v,i)=>final[i+1]=v);
  await set(ref(db,"keys"),final);
  alert("Inserted!");
 },{onlyOnce:true});
}

window.del = async(id)=>{ await remove(ref(db,"keys/"+id)); }
</script>
</body>
</html>