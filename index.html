<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Firebase Admin Panel (Google Login)</title>
<style>
body{font-family:Arial;margin:20px;background:#f5f6fa}
.card{background:white;padding:16px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);margin-bottom:16px}
input,button{padding:8px;margin:4px 0;border:1px solid #ccc;border-radius:5px;width:100%}
button{cursor:pointer;background:#2d89ef;color:white}
button.danger{background:#d9534f}
.row{display:flex;gap:8px}
.col{flex:1}
</style>
</head>
<body>
<h2>üî• Firebase JSON Admin Panel (Google Login)</h2>

<div class="card" id="loginCard">
  <h3>Admin Login</h3>
  <button id="googleLogin">üîê Sign in with Google</button>
</div>

<div class="card" id="panelCard" style="display:none">
  <h3>Add / Update Key</h3>
  <div class="row">
    <div class="col"><input id="deviceId" placeholder="Device ID"></div>
    <div class="col"><input id="key" placeholder="Key"></div>
    <div class="col"><input id="expiry" placeholder="Expiry (dd-mm-yyyy)"></div>
  </div>
  <input id="user" placeholder="User name (remark)">
  <label><input id="offline" type="checkbox"> Allow Offline</label>
  <button id="saveBtn">Save / Update</button>
  <div id="status"></div>
</div>

<div class="card" id="listCard" style="display:none">
  <h3>Existing Keys (Realtime)</h3>
  <div id="list"></div>
  <button id="logoutBtn" class="danger">Logout</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

// ‚úÖ ‡§Ü‡§™‡§ï‡§æ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyA1FIDLD-AKVlEz-AJiweYVdxhIP0Rnijk",
  authDomain: "opjat-2005.firebaseapp.com",
  databaseURL: "https://opjat-2005-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "opjat-2005",
  storageBucket: "opjat-2005.firebasestorage.app",
  messagingSenderId: "2500552965",
  appId: "1:2500552965:web:4f6664a366967a2525af6c"
};

// üîß Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const loginCard = document.getElementById('loginCard');
const panelCard = document.getElementById('panelCard');
const listCard = document.getElementById('listCard');
const googleLogin = document.getElementById('googleLogin');
const logoutBtn = document.getElementById('logoutBtn');

googleLogin.onclick = async () => {
  try {
    await signInWithPopup(auth, provider);
  } catch (err) {
    alert("Login failed: " + err.message);
  }
};

logoutBtn.onclick = () => {
  signOut(auth);
};

onAuthStateChanged(auth, user => {
  if (user) {
    loginCard.style.display = 'none';
    panelCard.style.display = 'block';
    listCard.style.display = 'block';
    loadRealtime();
  } else {
    loginCard.style.display = 'block';
    panelCard.style.display = 'none';
    listCard.style.display = 'none';
  }
});

document.getElementById('saveBtn').onclick = async () => {
  const id = document.getElementById('deviceId').value.trim();
  const key = document.getElementById('key').value.trim();
  const exp = document.getElementById('expiry').value.trim();
  const user = document.getElementById('user').value.trim();
  const allow = document.getElementById('offline').checked;

  if (!id || !key || !exp) { alert("Device ID, Key, and Expiry required"); return; }

  const data = { device_id:id, key:key, expirydate:exp, Allowoffline:allow, user:user };
  await set(ref(db, id), data);
  document.getElementById('status').innerText = "‚úÖ Saved!";
};

// realtime data list
function loadRealtime() {
  const list = document.getElementById('list');
  onValue(ref(db), (snapshot) => {
    const data = snapshot.val() || {};
    list.innerHTML = '';
    Object.keys(data).forEach(id => {
      const item = data[id];
      const div = document.createElement('div');
      div.innerHTML = `
        <b>${id}</b> ‚Äî ${item.user || ''}  
        <div>Key: ${item.key} | Expiry: ${item.expirydate}</div>
        <button class='danger' onclick="firebaseDelete('${id}')">Delete</button>
        <hr>
      `;
      list.appendChild(div);
    });
  });
}

window.firebaseDelete = async (id) => {
  if (confirm("Delete " + id + "?")) {
    await remove(ref(db, id));
  }
};
</script>
</body>
</html>
